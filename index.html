<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리동네 분리수거</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Inter", sans-serif; background-color: #f4f7f9; }
        .result-table td, .result-table th { padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; text-align: left; font-size: 0.875rem; vertical-align: top; }
        .result-table th { background-color: #f9fafb; font-weight: 600; }
        #floating-chat-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        #ai-chat-box { width: 350px; max-height: 80vh; display: none; flex-direction: column; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); border-radius: 0.75rem; overflow: hidden; background-color: #fff; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 0.75rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .user-message { background-color: #d1fae5; align-self: flex-end; border-bottom-right-radius: 0; padding: 0.5rem 0.75rem; border-radius: 0.5rem; max-width: 85%; font-size: 0.875rem;}
        .ai-message { background-color: #f3f4f6; align-self: flex-start; border-bottom-left-radius: 0; padding: 0.5rem 0.75rem; border-radius: 0.5rem; max-width: 85%; font-size: 0.875rem;}
        #chat-toggle-btn { background-color: #10b981; transition: transform 0.2s ease-in-out; }
        #chat-toggle-btn:hover { background-color: #059669; transform: scale(1.05); }
        details { background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        summary { padding: 0.75rem 1rem; cursor: pointer; font-weight: 600; color: #374151; display: flex; justify-content: space-between; align-items: center; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        details[open] > summary { border-bottom: 1px solid #e5e7eb; }
        .content-padding { padding: 0.75rem 1rem; }
        details details { margin-left: 0rem; margin-right: 0rem; margin-bottom: 0.5rem; background-color: #f9fafb; border: 1px solid #f3f4f6; }
        details details:last-child { margin-bottom: 0; }
        details details summary { font-weight: 500; padding: 0.5rem 1rem; background-color: #f9fafb; border-radius: 0; border-bottom: 1px dashed #e5e7eb; }
        details details[open] > summary { border-bottom: 1px dashed #e5e7eb; }
        details details .symbol-content, details details .guide-item-content, details details ul { padding: 0.75rem 1rem; font-size: 0.875rem; line-height: 1.6; color: #4b5563; background-color: #ffffff; border-top: none; border-radius: 0; }
        details details .guide-item-content p { margin-bottom: 0.25rem; }
        details details .guide-item-content p:last-child { margin-bottom: 0; }
        details details ul { list-style-type: disc; padding-left: 2rem; }
        .symbol-content strong, .guide-item-content b { font-weight: 600; color: #10b981; }
        .autocomplete-container { position: relative; }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #e5e7eb;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #ffffff;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-items div {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }
        .autocomplete-items div:last-child { border-bottom: none; }
        .autocomplete-items div:hover { background-color: #f9fafb; }
        .autocomplete-active { background-color: #eef2ff !important; color: #4338ca; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

<div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">우리동네 분리수거 도우미</h1>
    <p class="text-center text-gray-500 mb-8" id="service-area-info">서비스 지역 로딩 중...</p>

    <div class="space-y-4 mb-8 p-6 bg-gray-50 rounded-lg border">
         <h2 class="text-xl font-semibold text-gray-700">1. 우리 동네 배출 요일 및 시간 찾기</h2>
         <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-grow relative autocomplete-container">
                <input type="text" id="addressInput" placeholder="시/군/구 입력 (예: 군산시, 정선군, 종로구)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <button onclick="getCurrentLocation()" class="p-3 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 flex-shrink-0 flex items-center justify-center">현재 위치</button>
            <button onclick="handleSearch()" class="p-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 flex-shrink-0">배출 정보 검색</button>
         </div>
    </div>

    <div id="disposalInfo" class="mt-8 space-y-6">
        <div id="infoMessage" class="p-4 bg-blue-100 text-blue-800 rounded-lg border border-blue-200">
            <p>지역 정보를 검색하거나 '현재 위치'를 눌러 배출 정보를 확인하세요.</p>
        </div>
    </div>

    <div class="space-y-4 mt-12 p-6 bg-gray-50 rounded-lg border">
        <h2 class="text-xl font-semibold text-gray-700">2. 품목별 분리수거 방법 검색</h2>
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-grow relative autocomplete-container">
                <input type="text" id="itemSearchInput" placeholder="품목 입력 (예: 페트병, 영수증)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <button onclick="handleItemSearch()" class="p-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 flex-shrink-0">품목 검색</button>
        </div>
    </div>

    <div id="itemSearchResult" class="mt-8 space-y-6">
         <div id="itemInfoMessage" class="p-4 bg-blue-100 text-blue-800 rounded-lg border border-blue-200">
            <p>검색창에 분리수거할 품목(예: 페트병, 깨진 유리)을 입력하고 검색하세요.</p>
         </div>
    </div>

    <!-- 가이드 섹션 생략 (기존과 동일) -->
    <div class="mt-12 p-6 bg-emerald-50 rounded-xl shadow-inner">
        <details>
            <summary> <h2 class="text-xl font-semibold text-emerald-700 flex items-center"> <i data-lucide="recycle" class="w-6 h-6 mr-2"></i> 3. 일반 분리수거 가이드(환경부 기준) </h2> </summary>
            <div id="generalGuide" class="content-padding"><p class="text-gray-500 text-sm">데이터 로딩 중...</p></div>
        </details>
    </div>

    <div class="mt-8 p-6 bg-red-50 rounded-xl shadow-inner">
         <details>
             <summary> <h2 class="text-xl font-semibold text-red-700 flex items-center"> <i data-lucide="apple" class="w-6 h-6 mr-2"></i> 4. 음식물 쓰레기 구분 (환경부 기준) </h2> </summary>
             <div id="foodWasteGuide" class="content-padding"><p class="text-gray-500 text-sm">데이터 로딩 중...</p></div>
         </details>
    </div>

    <div class="mt-8 p-6 bg-yellow-50 rounded-xl shadow-inner">
         <details>
             <summary> <h2 class="text-xl font-semibold text-yellow-700 flex items-center"> <i data-lucide="info" class="w-6 h-6 mr-2"></i> 5. 재활용 표시 기호 설명 </h2> </summary>
             <div id="displaySymbolsGuide" class="content-padding"><p class="text-gray-500 text-sm">데이터 로딩 중...</p></div>
         </details>
    </div>
</div>

<!-- AI 챗봇 -->
<div id="floating-chat-container">
    <div id="ai-chat-box" class="bg-white rounded-xl shadow-2xl flex flex-col transition duration-300">
        <div class="p-3 border-b bg-emerald-600 text-white rounded-t-xl flex justify-between items-center">
            <span class="font-bold">AI 분리수거 Q&A</span>
            <button onclick="toggleChat()" class="text-white hover:text-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="chat-messages">
            <div class="ai-message">안녕하세요! 분리수거 관련 궁금한 점을 질문해 주세요.</div>
        </div>
        <div class="p-3 border-t flex gap-2">
            <input type="text" id="aiQueryInput" placeholder="질문 입력..." class="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-emerald-500" onkeydown="if(event.key === 'Enter') handleAiQuery()">
            <button onclick="handleAiQuery()" class="p-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600"><i data-lucide="send" class="w-5 h-5"></i></button>
        </div>
    </div>
    <button id="chat-toggle-btn" onclick="toggleChat()" class="w-14 h-14 rounded-full text-white shadow-lg flex items-center justify-center mt-3"> <i data-lucide="message-square" class="w-7 h-7"></i> </button>
</div>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
    const dataStore = {};
    let REGIONAL_CITY_LIST = [];
    let RECYCLING_ITEM_LIST = [];
    const API_URL_TEXT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';
    const API_KEY = 'YOUR_API_KEY_HERE';

    function parseCSV(text) { if (!text) return []; const lines = text.trim().split('\n'); if (lines.length < 2) return []; const headers = lines[0].split(',').map(h => h.trim()); return lines.slice(1).map(line => { const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []; return headers.reduce((obj, header, i) => { obj[header] = (values[i] || '').trim().replace(/^"|"$/g, '').replace(/""/g, '"'); return obj; }, {}); }); }

    async function loadData() {
        const infoMessage = document.getElementById('infoMessage');
        const itemInfoMessage = document.getElementById('itemInfoMessage');
        const serviceAreaInfo = document.getElementById('service-area-info');
        const guideDivs = {
            'generalGuide': document.getElementById('generalGuide'),
            'foodWasteGuide': document.getElementById('foodWasteGuide'),
            'displaySymbolsGuide': document.getElementById('displaySymbolsGuide')
        };

        const showLoading = (msg) => {
            if (infoMessage) infoMessage.innerHTML = `<p class="text-blue-800">${msg}</p>`;
            if (itemInfoMessage) itemInfoMessage.innerHTML = `<p class="text-blue-800">${msg}</p>`;
            if (serviceAreaInfo) serviceAreaInfo.textContent = '서비스 지역 로딩 중...';
            for (const key in guideDivs) {
                if (guideDivs[key]) guideDivs[key].innerHTML = `<p class="text-gray-500 text-sm">${msg}</p>`;
            }
        };

        const showError = (msg) => {
            const errorHtml = `<div class="p-4 bg-red-100 text-red-800 rounded-lg">${msg}</div>`;
            if (infoMessage) infoMessage.innerHTML = errorHtml;
            if (itemInfoMessage) itemInfoMessage.innerHTML = errorHtml;
            if (serviceAreaInfo) serviceAreaInfo.textContent = '서비스 지역 로드 실패';
            for (const key in guideDivs) {
                if (guideDivs[key]) guideDivs[key].innerHTML = `<p class="text-red-500 text-sm">${msg}</p>`;
            }
        };

        showLoading('데이터베이스 연결 중...');

        try {
            const sheetNames = ["지역정보", "쓰레기검색", "분리수거방법", "환경부기준", "표시구분", "지자체링크"];
            const fetchPromises = sheetNames.map(async (sheetName) => {
                const url = `${WEB_APP_URL}?sheet=${encodeURIComponent(sheetName)}`;
                try {
                    const response = await fetch(url, { cache: 'no-store' });
                    if (!response.ok) throw new Error(`Network response was not ok for ${sheetName} (status: ${response.status})`);
                    const csvText = await response.text();
                    if (csvText.startsWith("Error:")) throw new Error(`Apps Script Error for ${sheetName}: ${csvText}`);
                    const dataKey = (sheetName === '쓰레기검색') ? '재활용품목' : sheetName;
                    dataStore[dataKey] = parseCSV(csvText) || [];
                    console.log(`Successfully loaded and parsed data for: ${sheetName} (as ${dataKey})`, dataStore[dataKey]);
                } catch (fetchError) {
                    console.warn(`[${sheetName}] 데이터를 불러오는 중 오류: ${fetchError.message}`);
                    dataStore[sheetName === '쓰레기검색' ? '재활용품목' : sheetName] = [];
                }
            });
            await Promise.all(fetchPromises);

            if (dataStore['지역정보']?.length > 0) {
                const sidoSet = new Set();
                const citySet = new Set();
                dataStore['지역정보'].forEach(item => {
                    if (item['시도명']) sidoSet.add(item['시도명']);
                    if (item['시군구명'] && item['시도명']) citySet.add(`${item['시군구명']} (${item['시도명']})`);
                });
                REGIONAL_CITY_LIST = Array.from(citySet);
                serviceAreaInfo.textContent = `서비스 지역: 전국 (${sidoSet.size}개 시/도)`;
            } else {
                console.warn("'지역정보' data is empty or failed to load.");
                serviceAreaInfo.textContent = '서비스 지역 정보를 불러오지 못했습니다.';
                REGIONAL_CITY_LIST = [];
            }

            if (dataStore['재활용품목']?.length > 0) {
                RECYCLING_ITEM_LIST = dataStore['재활용품목'].map(item => item['재질/상세']).filter(Boolean);
            } else {
                console.warn("'재활용품목'(쓰레기검색) data is empty or failed to load.");
                RECYCLING_ITEM_LIST = [];
            }

            if (infoMessage) infoMessage.innerHTML = `<p>지역 정보를 검색하거나 '현재 위치'를 눌러 배출 정보를 확인하세요.</p>`;
            if (itemInfoMessage) itemInfoMessage.innerHTML = `<p>검색창에 분리수거할 품목(예: 페트병, 깨진 유리)을 입력하고 검색하세요.</p>`;

            displayGeneralGuide();
            displayFoodWasteGuide();
            displaySymbolsGuide();

            autocomplete(document.getElementById("addressInput"), REGIONAL_CITY_LIST, handleSearch);
            autocomplete(document.getElementById("itemSearchInput"), RECYCLING_ITEM_LIST, handleItemSearch);

        } catch (error) {
            console.error("Failed to load data:", error);
            showError(`데이터베이스 로드 실패: ${error.message}. 페이지를 새로고침하거나 앱 스크립트 배포 상태/URL을 확인하세요.`);
        }
    }

    window.addEventListener('DOMContentLoaded', () => { loadData(); });
</script>

<script>
    /* === 자동완성 함수 === */
    function autocomplete(inp, arr, onSelectCallback) {
        let currentFocus;
        inp.addEventListener("input", function() {
            const val = this.value;
            closeAllLists();
            if (!val) return false;
            currentFocus = -1;
            const a = document.createElement("DIV");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            let count = 0;
            for (let i = 0; i < arr.length && count < 10; i++) {
                if (arr[i].toLowerCase().includes(val.toLowerCase())) {
                    const b = document.createElement("DIV");
                    b.innerHTML = arr[i].replace(new RegExp(val, "gi"), match => `<strong>${match}</strong>`);
                    b.addEventListener("click", function() { inp.value = arr[i]; closeAllLists(); if(onSelectCallback) onSelectCallback(); });
                    a.appendChild(b);
                    count++;
                }
            }
        });

        inp.addEventListener("keydown", function(e) {
            let x = this.parentNode.querySelector(".autocomplete-items");
            if (x) x = x.getElementsByTagName("div");
            if (e.key === "ArrowDown") { currentFocus++; addActive(x); }
            else if (e.key === "ArrowUp") { currentFocus--; addActive(x); }
            else if (e.key === "Enter") { e.preventDefault(); if (currentFocus > -1 && x) { x[currentFocus].click(); } }
        });

        function addActive(x) { if (!x) return false; removeActive(x); if (currentFocus >= x.length) currentFocus = 0; if (currentFocus < 0) currentFocus = x.length - 1; x[currentFocus].classList.add("autocomplete-active"); }
        function removeActive(x) { for (let i = 0; i < x.length; i++) x[i].classList.remove("autocomplete-active"); }
        function closeAllLists(elmnt) { const items = document.getElementsByClassName("autocomplete-items"); for (let i = 0; i < items.length; i++) if (elmnt != items[i] && elmnt != inp) items[i].parentNode.removeChild(items[i]); }
        document.addEventListener("click", function (e) { closeAllLists(e.target); });
    }
</script>
<script>
    // === AI 챗봇 기본 함수 ===
    function toggleChat() { const chatBox = document.getElementById('ai-chat-box'); chatBox.style.display = chatBox.style.display === 'flex' ? 'none' : 'flex'; }
    async function handleAiQuery() {
        const input = document.getElementById('aiQueryInput'); if(!input.value.trim()) return;
        const messagesDiv = document.getElementById('chat-messages');
        const userMsg = document.createElement('div'); userMsg.className = 'user-message'; userMsg.textContent = input.value; messagesDiv.appendChild(userMsg); messagesDiv.scrollTop = messagesDiv.scrollHeight;
        const query = input.value; input.value = '';
        try {
            const response = await fetch(API_URL_TEXT, { method:'POST', headers:{ 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: query, temperature:0.7 }) });
            const data = await response.json();
            const aiMsg = document.createElement('div'); aiMsg.className='ai-message';
            aiMsg.textContent = data?.candidates?.[0]?.content || 'AI 응답을 받지 못했습니다.';
            messagesDiv.appendChild(aiMsg); messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } catch(e){ console.error(e); const aiMsg = document.createElement('div'); aiMsg.className='ai-message'; aiMsg.textContent = 'AI 응답 실패'; messagesDiv.appendChild(aiMsg); messagesDiv.scrollTop = messagesDiv.scrollHeight; }
    }
</script>
<script>
    // === 가이드 표시 예시 (데이터 로딩 후 호출) ===
    function displayGeneralGuide() { const div = document.getElementById('generalGuide'); div.innerHTML = '<p class="text-gray-700">일반 분리수거 가이드 예시 내용입니다.</p>'; }
    function displayFoodWasteGuide() { const div = document.getElementById('foodWasteGuide'); div.innerHTML = '<p class="text-gray-700">음식물 쓰레기 구분 예시 내용입니다.</p>'; }
    function displaySymbolsGuide() { const div = document.getElementById('displaySymbolsGuide'); div.innerHTML = '<p class="text-gray-700">재활용 표시 기호 설명 예시 내용입니다.</p>'; }
</script>

<script>
    // === 위치 & 검색 예시 ===
    function getCurrentLocation() { alert('현재 위치 기능은 브라우저 위치 API를 통해 구현 가능합니다.'); }
    function handleSearch() { alert('지역 검색 로직 호출'); }
    function handleItemSearch() { alert('품목 검색 로직 호출'); }
</script>
</body>
</html>
