<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리동네 분리수거 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Inter", sans-serif; background-color: #f4f7f9; }
        .result-table td, .result-table th { padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; text-align: left; font-size: 0.875rem; vertical-align: top; }
        .result-table th { background-color: #f9fafb; font-weight: 600; }

        /* *** AI 채팅창 스타일 (best.html 복사 + 일부 수정) *** */
        #floating-chat-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        #ai-chat-box { 
            width: 350px; 
            max-height: 80vh; 
            display: none; /* best.html 방식: 기본 숨김 */
            /* flex-direction 제거 (best.html에는 없음) */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); 
            border-radius: 0.75rem; 
            overflow: hidden; 
            background-color: #fff; 
        }
        /* best.html의 #chat-messages 스타일 적용 */
        #chat-messages { 
            max-height: calc(80vh - 120px); /* best.html 방식 */
            overflow-y: auto; 
            padding: 0.75rem; 
            display: flex; /* 메시지 정렬 위해 유지 */
            flex-direction: column; /* 메시지 정렬 위해 유지 */
            gap: 0.75rem; 
        }
        /* best.html의 메시지 스타일 적용 */
        .user-message { background-color: #d1fae5; align-self: flex-end; border-bottom-right-radius: 0; padding: 0.5rem 0.75rem; border-radius: 0.5rem; max-width: 85%; font-size: 0.875rem;}
        .ai-message { background-color: #f3f4f6; align-self: flex-start; border-bottom-left-radius: 0; padding: 0.5rem 0.75rem; border-radius: 0.5rem; max-width: 85%; font-size: 0.875rem;}

        #chat-toggle-btn { background-color: #10b981; transition: transform 0.2s ease-in-out; }
        #chat-toggle-btn:hover { background-color: #059669; transform: scale(1.05); }

        /* 이중 아코디언 스타일 */
        details { background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        summary { padding: 0.75rem 1rem; cursor: pointer; font-weight: 600; color: #374151; display: flex; justify-content: space-between; align-items: center; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        details[open] > summary { border-bottom: 1px solid #e5e7eb; }
        .content-padding { padding: 0.75rem 1rem; }
        details details { margin-left: 0rem; margin-right: 0rem; margin-bottom: 0.5rem; background-color: #f9fafb; border: 1px solid #f3f4f6; }
        details details:last-child { margin-bottom: 0; }
        details details summary { font-weight: 500; padding: 0.5rem 1rem; background-color: #f9fafb; border-radius: 0; border-bottom: 1px dashed #e5e7eb; }
        details details[open] > summary { border-bottom: 1px dashed #e5e7eb; }
        details details .symbol-content, details details .guide-item-content, details details ul { padding: 0.75rem 1rem; font-size: 0.875rem; line-height: 1.6; color: #4b5563; background-color: #ffffff; border-top: none; border-radius: 0; }
        details details .guide-item-content p { margin-bottom: 0.25rem; }
        details details .guide-item-content p:last-child { margin-bottom: 0; }
        details details ul { list-style-type: disc; padding-left: 2rem; }
        .symbol-content strong, .guide-item-content b { font-weight: 600; color: #10b981; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">우리동네 분리수거 도우미</h1>
        <p class="text-center text-gray-500 mb-8">서비스 지역: 전북특별자치도 (14개 시/군)</p>
        <div class="space-y-4 mb-8 p-6 bg-gray-50 rounded-lg border"> <h2 class="text-xl font-semibold text-gray-700">1. 우리 동네 배출 요일 및 시간 찾기</h2> <div class="flex flex-col md:flex-row gap-4"> <input type="text" id="addressInput" placeholder="전북특별자치도 내 시/군 입력 (예: 군산시, 군산)" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500" onkeydown="if(event.key === 'Enter') handleSearch()"> <button onclick="getCurrentLocation()" class="p-3 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 flex-shrink-0 flex items-center justify-center"> <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i> 현재 위치 </button> <button onclick="handleSearch()" class="p-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 flex-shrink-0"> 배출 정보 검색 </button> </div> </div>
        <div id="disposalInfo" class="mt-8 space-y-6"> <div id="infoMessage" class="p-4 bg-blue-100 text-blue-800 rounded-lg border border-blue-200"> <p><b>전북특별자치도 14개 시/군</b> 내 주소를 검색하거나 '현재 위치'를 눌러 배출 정보를 확인하세요.</p> </div> </div>
        <div class="mt-12 p-6 bg-emerald-50 rounded-xl shadow-inner"> <details> <summary> <h2 class="text-xl font-semibold text-emerald-700 flex items-center"> <i data-lucide="recycle" class="w-6 h-6 mr-2"></i> 2. 일반 분리수거 가이드(환경부 기준) </h2> </summary> <div id="generalGuide" class="content-padding"><p class="text-gray-500 text-sm">데이터 로딩 중...</p></div> </details> </div>
        <div class="mt-8 p-6 bg-red-50 rounded-xl shadow-inner"> <details> <summary> <h2 class="text-xl font-semibold text-red-700 flex items-center"> <i data-lucide="apple" class="w-6 h-6 mr-2"></i> 3. 음식물 쓰레기 구분 (환경부 기준) </h2> </summary> <div id="foodWasteGuide" class="content-padding"><p class="text-gray-500 text-sm">데이터 로딩 중...</p></div> </details> </div>
        <div class="mt-8 p-6 bg-yellow-50 rounded-xl shadow-inner"> <details> <summary> <h2 class="text-xl font-semibold text-yellow-700 flex items-center"> <i data-lucide="info" class="w-6 h-6 mr-2"></i> 4. 재활용 표시 기호 설명 </h2> </summary> <div id="displaySymbolsGuide" class="content-padding"><p class="text-gray-500 text-sm">데이터 로딩 중...</p></div> </details> </div>
    </div>

    <div id="floating-chat-container">
        <div id="ai-chat-box" class="bg-white rounded-xl shadow-2xl flex flex-col transition duration-300">
            <div class="p-3 border-b bg-emerald-600 text-white rounded-t-xl flex justify-between items-center">
                <span class="font-bold">AI 분리수거 Q&A</span>
                <button onclick="toggleChat()" class="text-white hover:text-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="chat-messages">
                <div class="ai-message p-3 rounded-xl text-sm max-w-[85%]"> 
                    안녕하세요! 분리수거 관련 궁금한 점을 질문해 주세요. 예: "테이크아웃 컵은 어떻게 버려야 하나요?"
                </div>
            </div>
            <div class="p-3 border-t flex gap-2">
                <input type="text" id="aiQueryInput" placeholder="질문 입력..." class="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-emerald-500" onkeydown="if(event.key === 'Enter') handleAiQuery()">
                <button onclick="handleAiQuery()" class="p-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600"><i data-lucide="send" class="w-5 h-5"></i></button>
            </div>
        </div>
        <button id="chat-toggle-btn" onclick="toggleChat()" class="w-14 h-14 rounded-full text-white shadow-lg flex items-center justify-center mt-3"> <i data-lucide="message-square" class="w-7 h-7"></i> </button>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // --- DATA STORE ---
        const CSV_CONTENTS = { /* (내용 동일) */ };
        const dataStore = {};
        let JEONBUK_CITIES_LIST = []; 
        
        // *** Gemini API 설정 (best.html 복사) ***
        const API_URL_TEXT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        const API_KEY = "AIzaSyD06Ea2CGbQtLTwFPayf9Z6C-0Jbg651UM"; 

        // === 모든 함수 정의 (전역 스코프) ===

        function parseCSV(text) { /* (내용 동일) */ }
        function loadData() { /* (내용 동일) */ }
        function displayDisposalInfo(results, address) { /* (내용 동일, 시각 정보 포함) */ }
        function displayGeneralGuide() { /* (내용 동일, 이중 아코디언) */ }
        function displayFoodWasteGuide() { /* (내용 동일, 이중 아코디언) */ }
        function displaySymbolsGuide() { /* (내용 동일, 이중 아코디언) */ }
        function searchRegionalData(address) { /* (12.html 방식으로 복구된 내용) */ }
        function handleSearch() { /* (자동완성 제거된 내용) */ }
        async function getCurrentLocation() { /* (내용 동일) */ }

        // *** AI 채팅 토글 (best.html 코드 복원) ***
        function toggleChat() { 
            const chatBox = document.getElementById('ai-chat-box');
            const toggleBtn = document.getElementById('chat-toggle-btn'); // best.html 변수명 사용
            const isHidden = chatBox.style.display === 'none' || chatBox.style.display === '';
            
            chatBox.style.display = isHidden ? 'flex' : 'none'; // best.html은 flex 사용
            toggleBtn.innerHTML = isHidden ? '<i data-lucide="x" class="w-7 h-7"></i>' : '<i data-lucide="message-square" class="w-7 h-7"></i>';
            
            safeCreateIcons(); // 아이콘 재생성
            if (isHidden) { 
                const messages = document.getElementById('chat-messages'); 
                messages.scrollTop = messages.scrollHeight; 
            } 
        }

        // *** AI API 호출 함수 (best.html 코드 복원) ***
        async function callGeminiAPI(query) {
            const systemPrompt = "당신은 한국의 분리수거 전문가 챗봇입니다. 사용자의 질문에 친절하고 정확하게, 한국어로 간결한 한 단락으로 답하세요.";
            const finalUrl = `${API_URL_TEXT}?key=${API_KEY}`;
            const payload = { 
                contents: [{ parts: [{ text: query }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }, 
                // best.html에는 tools가 있었으나, 현재 모델에는 불필요하므로 제외
            }; 
            try { 
                const response = await fetch(finalUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                if (!response.ok) throw new Error(`API call failed: ${response.status}`); 
                const result = await response.json(); 
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "죄송합니다. AI가 답변을 생성하지 못했습니다."; 
            } catch (error) { 
                console.error("Gemini API Error:", error); 
                // best.html은 간단한 메시지 사용
                return "죄송합니다. AI 서버 연결에 문제가 발생했습니다."; 
            }
        }

        // *** AI 채팅 전송 핸들러 (best.html 코드 복원) ***
        async function handleAiQuery() { 
            const inputElement = document.getElementById('aiQueryInput'); // best.html 변수명
            const query = inputElement.value.trim(); 
            if (!query) return; 
            const chatMessages = document.getElementById('chat-messages'); 
            
            // best.html 방식의 appendMessage 정의
            const appendMessage = (sender, text) => { 
                const messageDiv = document.createElement('div'); 
                // best.html 클래스 적용
                messageDiv.className = `p-3 rounded-xl text-sm max-w-[85%] ${sender === 'user' ? 'user-message self-end' : 'ai-message self-start'}`; 
                messageDiv.innerHTML = text.replace(/\n/g, '<br>'); 
                chatMessages.appendChild(messageDiv); 
                chatMessages.scrollTop = chatMessages.scrollHeight; 
            }; 

            appendMessage('user', query); 
            inputElement.value = ''; 
            inputElement.disabled = true; 
            
            // best.html 방식의 로딩 표시
            const loadingDiv = document.createElement('div'); 
            loadingDiv.id = 'ai-loading'; 
            loadingDiv.className = 'ai-message p-3 rounded-xl text-sm max-w-[85%] self-start flex items-center bg-gray-200'; 
            loadingDiv.innerHTML = '<div class="loader inline-block w-4 h-4 border-2 border-t-2 border-gray-100 border-t-gray-500 rounded-full animate-spin mr-2"></div> AI가 답변을 생성 중입니다...'; 
            chatMessages.appendChild(loadingDiv); 
            chatMessages.scrollTop = chatMessages.scrollHeight; 

            const responseText = await callGeminiAPI(query); 
            
            document.getElementById('ai-loading')?.remove(); 
            appendMessage('ai', responseText); 
            inputElement.disabled = false; 
            inputElement.focus(); 
        }

        function safeCreateIcons() { if (window.lucide) { lucide.createIcons(); } }
        
        // --- 페이지 로드 시 초기화 ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData(); 
            safeCreateIcons(); 
        });

        // --- (함수 정의 내용 간결화를 위해 생략된 부분 복원) ---
        // (parseCSV, loadData, display... 함수들 정의 포함됨)
        function parseCSV(text) { if (!text) return []; const lines = text.trim().split('\n'); if (lines.length < 2) return []; const headers = lines[0].split(',').map(h => h.trim()); return lines.slice(1).map(line => { const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []; return headers.reduce((obj, header, i) => { obj[header] = (values[i] || '').trim().replace(/"/g, ''); return obj; }, {}); }); }
        function loadData() { for (const key in CSV_CONTENTS) { dataStore[key] = parseCSV(CSV_CONTENTS[key]); } if (dataStore['전북특별자치도']) { const citySet = new Set(dataStore['전북특별자치도'].map(item => item['시군구명'])); JEONBUK_CITIES_LIST = Array.from(citySet); } displayGeneralGuide(); displayFoodWasteGuide(); displaySymbolsGuide(); }
        function displayDisposalInfo(results, address) { const infoDiv = document.getElementById('disposalInfo'); infoDiv.innerHTML = ''; if (results.length === 0) { infoDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-800 border-red-200 rounded-lg"><h3 class="text-xl font-bold mb-2 flex items-center"><i data-lucide="x-circle" class="w-5 h-5 mr-2"></i> 검색 결과 없음</h3><p>입력하신 <b>'${address}'</b>에 대한 정보를 찾을 수 없습니다. <b>전북특별자치도 14개 시/군</b> 내 지역인지 확인해주세요.</p></div>`; safeCreateIcons(); return; } let html = ''; for (const data of results) { if (data.isLinkOnly) { html += `<div class="p-4 bg-yellow-100 text-yellow-800 border-yellow-200 rounded-lg"><h3 class="text-xl font-bold mb-2 flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> ${data['시군구명']} 공식 링크</h3><p>상세 배출 정보는 없지만, <b>${data['시군구명']}</b>의 공식 페이지에서 정보를 확인 할 수 있습니다.</p><a href="${data['url']}" target="_blank" class="text-blue-600 hover:underline font-semibold flex items-center mt-2"><i data-lucide="external-link" class="w-4 h-4 mr-1"></i> ${data['시군구명']} 쓰레기 배출 안내 페이지</a></div>`; } else { const cleanDays = (days) => (days || '정보 없음').replace(/\+/g, ', '); const contact = data['관리부서전화번호'] ? `<a href="tel:${data['관리부서전화번호']}" class="text-blue-600 hover:underline">${data['관리부서전화번호']}</a>` : '정보 없음'; const linkData = dataStore['지자체링크']; const linkMatch = linkData.find(l => l['시군구명'] === data['시군구명']); const officialLink = linkMatch ? `<p class="text-sm mt-2"><a href="${linkMatch.url}" target="_blank" rel="noopener noreferrer" class="font-semibold text-blue-600 hover:underline">공식 지자체 안내 페이지 바로가기</a></p>` : ''; const subTitle = data['관리구역대상지역명'].includes('전역') || data['관리구역대상지역명'].includes('전지역') ? '' : `(${data['관리구역대상지역명']})`; const formatTime = (time) => time ? time : '정보 없음'; html += `<div class="p-4 bg-green-100 text-green-800 border-green-200 rounded-lg space-y-4"><h3 class="text-xl font-bold flex items-center"><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> ${data['시군구명']} ${subTitle} 배출 정보</h3><div class="result-table overflow-x-auto"><table class="w-full table-fixed"><thead class="bg-gray-200/50"><tr><th class="w-1/6">구분</th><th class="w-1/4">배출 요일</th><th class="w-1/6">시작</th><th class="w-1/6">종료</th><th class="w-1/4">배출 방법</th></tr></thead><tbody><tr><td class="font-semibold">생활</td><td>${cleanDays(data['생활쓰레기배출요일'])}</td><td>${formatTime(data['생활쓰레기배출시작시각'])}</td><td>${formatTime(data['생활쓰레기배출종료시각'])}</td><td>${data['생활쓰레기배출방법'] || '정보 없음'}</td></tr><tr><td class="font-semibold">음식물</td><td>${cleanDays(data['음식물쓰레기배출요일'])}</td><td>${formatTime(data['음식물쓰레기배출시작시각'])}</td><td>${formatTime(data['음식물쓰레기배출종료시각'])}</td><td>${data['음식물쓰레기배출방법'] || '정보 없음'}</td></tr><tr><td class="font-semibold">재활용</td><td>${cleanDays(data['재활용품배출요일'])}</td><td>${formatTime(data['재활용품배출시작시각'])}</td><td>${formatTime(data['재활용품배출종료시각'])}</td><td>${data['재활용품배출방법'] || '정보 없음'}</td></tr></tbody></table></div><div class="mt-4 p-3 bg-white rounded-lg border text-gray-700"><p class="text-sm"><b>관리 부서:</b> ${data['관리부서명'] || '정보 없음'} | <b>연락처:</b> ${contact}</p>${officialLink}</div></div>`; } } infoDiv.innerHTML = html; safeCreateIcons(); }
        function displayGeneralGuide() { const guideDiv = document.getElementById('generalGuide'); const data = dataStore['분리수거방법']; if (!data || data.length === 0) { guideDiv.innerHTML = '<p class="text-red-500 text-sm">가이드 데이터를 불러오지 못했습니다.</p>'; return; } let html = ''; const categories = data.reduce((acc, item) => { const category = item['구분'] || '기타'; if (!acc[category]) acc[category] = []; acc[category].push(item); return acc; }, {}); for (const category in categories) { html += `<details><summary><span>${category}</span></summary><div class="content-padding space-y-2">`; categories[category].forEach(item => { html += `<details><summary><span>${item['항목']}</span></summary><div class="guide-item-content"><p><b>배출 방법:</b> ${item['배출 방법']}</p><p><b>참고 사항:</b> ${item['참고 사항'] || '없음'}</p></div></details>`; }); html += `</div></details>`; } guideDiv.innerHTML = html; safeCreateIcons(); }
        function displayFoodWasteGuide() { const guideDiv = document.getElementById('foodWasteGuide'); const data = dataStore['환경부기준']; if (!data || data.length === 0) { guideDiv.innerHTML = '<p class="text-red-500 text-sm">가이드 데이터를 불러오지 못했습니다.</p>'; return; } const food = data.filter(item => item['구분']?.includes('음식물')); const general = data.filter(item => item['구분']?.includes('일반')); const createList = (items) => `<ul>${items.map(item => `<li>${item['항목']}</li>`).join('')}</ul>`; let html = `<details><summary><span><i data-lucide="thumbs-up" class="w-5 h-5 inline-block mr-2 text-green-700"></i>음식물 쓰레기</span></summary><div class="content-padding">${createList(food)}</div></details><details><summary><span><i data-lucide="trash-2" class="w-5 h-5 inline-block mr-2 text-red-700"></i>일반 쓰레기</span></summary><div class="content-padding">${createList(general)}</div></details>`; guideDiv.innerHTML = html; safeCreateIcons(); }
        function displaySymbolsGuide() { const guideDiv = document.getElementById('displaySymbolsGuide'); const data = dataStore['표시구분']; if (!data || data.length === 0) { guideDiv.innerHTML = '<p class="text-red-500 text-sm">표시 구분 데이터를 불러오지 못했습니다.</p>'; return; } let html = ''; data.forEach(item => { html += `<details><summary><span>${item['약어']} (${item['한글명']})</span></summary><div class="symbol-content"><strong>${item['영문명']}</strong><br>${item['특징']}<br><strong>예시:</strong> ${item['예시']}<br><strong>재활용:</strong> ${item['재활용']}</div></details>`; }); guideDiv.innerHTML = html; safeCreateIcons(); }
        function searchRegionalData(address) { const regionData = dataStore['전북특별자치도']; if (!regionData) return []; const matches = regionData.filter(item => address.includes(item['시군구명']) || item['시군구명'].startsWith(address)); if (matches.length > 0) return matches; const linkData = dataStore['지자체링크']; const linkMatch = linkData.find(l => address.includes(l['시군구명'])); if (linkMatch) return [{ isLinkOnly: true, ...linkMatch }]; return []; }
        async function getCurrentLocation() { const infoDiv = document.getElementById('disposalInfo'); infoDiv.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">위치 정보를 가져오는 중...</div>`; if (!navigator.geolocation) { infoDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded-lg">이 브라우저는 위치 정보 기능을 지원하지 않습니다.</div>`; return; } try { const pos = await new Promise((resolve, reject) => { navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000 }); }); const lat = pos.coords.latitude; const lon = pos.coords.longitude; const kakaoApiKey = '338f060fb335bc71e86b290a133aaaaa'; const url = `https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lon}&y=${lat}&input_coord=WGS84`; const response = await fetch(url, { headers: { 'Authorization': `KakaoAK ${kakaoApiKey}` } }); const data = await response.json(); if (!data.documents || data.documents.length === 0) { infoDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded-lg">주소 변환에 실패했습니다.</div>`; return; } const address = data.documents[0].address.region_2depth_name; if (!data.documents[0].address.region_1depth_name.includes('전북')) { infoDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded-lg"><b>서비스 지역이 아닙니다.</b><br>현재 위치(${address})는 전북특별자치도 14개 시/군 내가 아닙니다.</div>`; return; } document.getElementById('addressInput').value = address; handleSearch(); } catch (error) { console.error("위치 정보 오류:", error); infoDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded-lg">위치 정보를 가져오는 중 오류가 발생했습니다. (권한을 허용했는지 확인하세요)</div>`; } }
        
    </script>
</body>
</html>

